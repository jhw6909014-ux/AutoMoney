#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os, sys, json, random, hashlib, smtplib, time
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# [CONFIG]
RSS_KEYWORD = "smartphone review OR AI technology OR nvidia news OR apple rumors"
BLOGGER_EMAIL = "jhw6909014.money2025@blogger.com"
AFFILIATE_MAP = {"default":"https://s.shopee.tw/4q8RoXHOja","apple":"https://s.shopee.tw/1qUqF3scBf","iphone":"https://s.shopee.tw/1qUqF3scBf","mac":"https://s.shopee.tw/1qUqF3scBf","ios":"https://s.shopee.tw/1qUqF3scBf","android":"https://s.shopee.tw/4Asl1N0Vya","samsung":"https://s.shopee.tw/4Asl1N0Vya","pixel":"https://s.shopee.tw/4Asl1N0Vya","oppo":"https://s.shopee.tw/4Asl1N0Vya","laptop":"https://s.shopee.tw/Lg2SLfJBA","asus":"https://s.shopee.tw/Lg2SLfJBA","msi":"https://s.shopee.tw/Lg2SLfJBA","acer":"https://s.shopee.tw/Lg2SLfJBA","hp":"https://s.shopee.tw/Lg2SLfJBA","gpu":"https://s.shopee.tw/70CwOcg85W","nvidia":"https://s.shopee.tw/70CwOcg85W","rtx":"https://s.shopee.tw/70CwOcg85W","amd":"https://s.shopee.tw/70CwOcg85W","cpu":"https://s.shopee.tw/70CwOcg85W","headphone":"https://s.shopee.tw/5VO8btbgNo","airpods":"https://s.shopee.tw/5VO8btbgNo","sony":"https://s.shopee.tw/40ZKp9zH86","bose":"https://s.shopee.tw/5VO8btbgNo","camera":"https://s.shopee.tw/40ZKp9zH86","canon":"https://s.shopee.tw/40ZKp9zH86","lens":"https://s.shopee.tw/40ZKp9zH86"}
HISTORY_FILE = "history.txt"
STYLES = ["ÊØíËàåÁßëÊäÄË©ïË´ñ","Êï∏ÊìöÂàÜÊûêÂ∏´","3CÁôºÁáíÂèã","ÁüΩË∞∑ËßÄÂØüÂÆ∂","ÊïóÂÆ∂ÈñãÁÆ±"]

def log(msg, level="INFO"):
    print(f"[{level}] {msg}")

def fail(msg):
    log(msg, "FATAL")
    sys.exit(1)

# [CHECK ENV]
try:
    import feedparser
    import google.generativeai as genai
except ImportError as e:
    fail(f"Libraries missing: {e}")

ENV = {
    "KEY": os.environ.get("GOOGLE_API_KEY"),
    "USER": os.environ.get("GMAIL_USER"),
    "PW": os.environ.get("GMAIL_APP_PASSWORD")
}
if not ENV["KEY"] or not ENV["USER"] or not ENV["PW"]: fail("Missing Secrets!")

# [RSS]
rss_url = f"https://news.google.com/rss/search?q={RSS_KEYWORD}+when:1d&hl=en-US&gl=US&ceid=US:en"
log(f"Fetching: {rss_url}")
feed = feedparser.parse(rss_url)
if not feed.entries:
    log("Trying fallback keyword 'technology'...", "WARN")
    feed = feedparser.parse("https://news.google.com/rss/search?q=technology+when:1d&hl=en-US&gl=US&ceid=US:en")
    if not feed.entries: fail("No news found.")

# [HISTORY]
history = set()
if os.path.exists(HISTORY_FILE):
    with open(HISTORY_FILE, 'r') as f: history = {line.strip() for line in f}

target = None
target_tid = None
for entry in feed.entries[:5]:
    tid = hashlib.sha256(entry.title.encode()).hexdigest()
    if tid not in history:
        target = entry
        target_tid = tid
        break

if not target:
    log("All news processed.")
    sys.exit(0)

# [AI GENERATION - MULTI MODEL]
models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro']
genai.configure(api_key=ENV["KEY"])
generated = None

prompt = f"""
Act as a blogger. Style: {random.choice(STYLES)}.
Rewrite news to Traditional Chinese (Taiwan) HTML.
News: {target.title}
Summary: {getattr(target, 'summary', '')}
Format JSON: {{ "valid": true, "title": "...", "body": "..." }}
"""

for m in models:
    log(f"Trying AI model: {m}...")
    try:
        model = genai.GenerativeModel(m)
        res = model.generate_content(prompt)
        data = json.loads(res.text.replace('```json','').replace('```',''))
        if data.get("valid"):
            generated = data
            break
    except Exception as e:
        log(f"Model {m} failed: {e}", "WARN")
        time.sleep(1)

if not generated: fail("All AI models failed.")

# [LINKING]
link = AFFILIATE_MAP["default"]
content = (generated["title"] + generated["body"]).lower()
for k, v in AFFILIATE_MAP.items():
    if k != "default" and k in content:
        link = v
        log(f"Matched keyword: {k}")
        break

# [EMAIL]
try:
    msg = MIMEMultipart()
    msg['Subject'] = generated["title"]
    msg['From'] = ENV["USER"]
    msg['To'] = BLOGGER_EMAIL
    btn = f'<br><div style="text-align:center;margin:30px;"><a href="{link}" style="background:#4f46e5;color:white;padding:12px 28px;border-radius:30px;text-decoration:none;font-weight:bold;">üëâ Êü•ÁúãÁõ∏ÈóúÂÑ™ÊÉ†</a></div>'
    msg.attach(MIMEText(generated["body"] + btn, 'html'))
    
    server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
    server.login(ENV["USER"], ENV["PW"])
    server.send_message(msg)
    server.quit()
    
    with open(HISTORY_FILE, 'a') as f: f.write(target_tid + "\n")
    log("Success!")
except Exception as e:
    fail(f"SMTP Error: {e}")
