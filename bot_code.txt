#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Bot Project: AutoMoney
import os, sys, json, random, hashlib, smtplib, logging
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

try:
    import feedparser
    import google.generativeai as genai
except:
    sys.exit(0)

CONFIG = {
    "RSS": "https://news.google.com/rss/search?q=smartphone%20review%20OR%20AI%20news%20OR%20apple%20rumors+when:1d&hl=en-US&gl=US&ceid=US:en",
    "CAT": "tech",
    "STYLES": ["ÊØíËàåÁßëÊäÄË©ïË´ñ","Êï∏ÊìöÂàÜÊûêÂ∏´","3CÁôºÁáíÂèã","ÁüΩË∞∑ËßÄÂØüÂÆ∂","ÊïóÂÆ∂ÈñãÁÆ±"],
    "MAP": {"default":"https://s.shopee.tw/8KiFryWcEl","apple":"https://s.shopee.tw/9zqTr3UP7A","iphone":"https://s.shopee.tw/9zqTr3UP7A","mac":"https://s.shopee.tw/9zqTr3UP7A","ios":"https://s.shopee.tw/9zqTr3UP7A","android":"https://s.shopee.tw/20oCKNKJh9","samsung":"https://s.shopee.tw/20oCKNKJh9","pixel":"https://s.shopee.tw/20oCKNKJh9","oppo":"https://s.shopee.tw/20oCKNKJh9","laptop":"https://s.shopee.tw/70CwK7vpZI","asus":"https://s.shopee.tw/70CwK7vpZI","msi":"https://s.shopee.tw/70CwK7vpZI","acer":"https://s.shopee.tw/70CwK7vpZI","hp":"https://s.shopee.tw/70CwK7vpZI","gpu":"https://s.shopee.tw/805TVzZTnM","nvidia":"https://s.shopee.tw/805TVzZTnM","rtx":"https://s.shopee.tw/805TVzZTnM","amd":"https://s.shopee.tw/805TVzZTnM","cpu":"https://s.shopee.tw/805TVzZTnM","headphone":"https://s.shopee.tw/4VVbLadocg","airpods":"https://s.shopee.tw/4VVbLadocg","sony":"https://s.shopee.tw/50RrwXf1SX","bose":"https://s.shopee.tw/4VVbLadocg","camera":"https://s.shopee.tw/50RrwXf1SX","canon":"https://s.shopee.tw/50RrwXf1SX","lens":"https://s.shopee.tw/50RrwXf1SX"},
    "HISTORY": "history.txt"
}
ENV = {
    "KEY": os.environ.get("GOOGLE_API_KEY"),
    "USER": os.environ.get("GMAIL_USER"),
    "PW": os.environ.get("GMAIL_APP_PASSWORD"),
    "TO": "jhw6909014.money2025@blogger.com"
}

logging.basicConfig(level=logging.INFO)

def get_smart_link(text):
    text = text.lower()
    for k, v in CONFIG["MAP"].items():
        if k != "default" and k in text: return v
    return CONFIG["MAP"]["default"]

def run():
    genai.configure(api_key=ENV["KEY"])
    feed = feedparser.parse(CONFIG["RSS"])
    if not feed.entries: return
    
    history = set()
    if os.path.exists(CONFIG["HISTORY"]):
        history = set(line.strip() for line in open(CONFIG["HISTORY"]))
        
    for entry in feed.entries[:5]:
        tid = hashlib.sha256(entry.title.encode()).hexdigest()
        if tid in history: continue
        
        model = genai.GenerativeModel('gemini-1.5-flash')
        style = random.choice(CONFIG["STYLES"])
        prompt = f"""
        Role: Blogger ({CONFIG['CAT']}). Tone: {style}.
        News: {entry.title}
        Summary: {getattr(entry, 'summary', '')}
        Task: Rewrite to Traditional Chinese (Taiwan) blog post HTML.
        Format JSON: {{ "valid": true, "title": "...", "body": "..." }}
        Must include valid: false if unrelated.
        """
        try:
            res = model.generate_content(prompt)
            data = json.loads(res.text.replace('```json','').replace('```',''))
            if data.get("valid"):
                link = get_smart_link(data["title"] + data["body"])
                btn = f'<br><div style="text-align:center;margin:30px;"><a href="{link}" style="background:#d97706;color:white;padding:12px 28px;border-radius:30px;text-decoration:none;font-weight:bold;">üëâ Êü•ÁúãÂÑ™ÊÉ† / Áõ∏ÈóúÂïÜÂìÅ</a></div>'
                msg = MIMEMultipart()
                msg['Subject'] = data["title"]
                msg['From'] = ENV["USER"]
                msg['To'] = ENV["TO"]
                msg.attach(MIMEText(data["body"] + btn, 'html'))
                with smtplib.SMTP_SSL('smtp.gmail.com', 465) as s:
                    s.login(ENV["USER"], ENV["PW"])
                    s.send_message(msg)
                with open(CONFIG["HISTORY"], 'a') as f: f.write(tid + "\n")
                break
        except Exception as e:
            logging.error(e)
if __name__ == "__main__":
    run()
