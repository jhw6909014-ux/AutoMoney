#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os, sys, json, random, hashlib, smtplib, time
import urllib.parse
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# [CONFIG]
RSS_KEYWORD = "smartphone review OR AI technology OR nvidia news OR apple rumors"
BLOGGER_EMAIL = "jhw6909014.money2025@blogger.com"
AFFILIATE_MAP = {"default":"https://s.shopee.tw/5AlLE1hLay","apple":"https://s.shopee.tw/805WbFx2Ke","iphone":"https://s.shopee.tw/805WbFx2Ke","mac":"https://s.shopee.tw/805WbFx2Ke","ios":"https://s.shopee.tw/805WbFx2Ke","ipad":"https://s.shopee.tw/805WbFx2Ke","watch":"https://s.shopee.tw/805WbFx2Ke","android":"https://s.shopee.tw/4q8UpSv5Jw","samsung":"https://s.shopee.tw/4q8UpSv5Jw","pixel":"https://s.shopee.tw/4q8UpSv5Jw","oppo":"https://s.shopee.tw/4q8UpSv5Jw","xiaomi":"https://s.shopee.tw/4q8UpSv5Jw","laptop":"https://s.shopee.tw/9fDkaMy4b3","asus":"https://s.shopee.tw/9fDkaMy4b3","msi":"https://s.shopee.tw/9fDkaMy4b3","acer":"https://s.shopee.tw/9fDkaMy4b3","hp":"https://s.shopee.tw/9fDkaMy4b3","dell":"https://s.shopee.tw/9fDkaMy4b3","gpu":"https://s.shopee.tw/3LJh2khVGS","nvidia":"https://s.shopee.tw/3LJh2khVGS","rtx":"https://s.shopee.tw/3LJh2khVGS","amd":"https://s.shopee.tw/3LJh2khVGS","cpu":"https://s.shopee.tw/3LJh2khVGS","headphone":"https://s.shopee.tw/7V9G0RVv7r","airpods":"https://s.shopee.tw/7V9G0RVv7r","sony":"https://s.shopee.tw/7V9G0RVv7r","bose":"https://s.shopee.tw/7V9G0RVv7r","speaker":"https://s.shopee.tw/7V9G0RVv7r"}
HISTORY_FILE = "history.txt"
STYLES = ["æ¯’èˆŒç§‘æŠ€è©•è«–","æ•¸æ“šåˆ†æžå¸«","3Cç™¼ç‡’å‹","çŸ½è°·è§€å¯Ÿå®¶","æ•—å®¶é–‹ç®±"]

def log(msg, level="INFO"):
    print(f"[{level}] {msg}")

def fail(msg):
    log(msg, "FATAL")
    sys.exit(1)

# [CHECK ENV]
try:
    import feedparser
    import google.generativeai as genai
except ImportError as e:
    fail(f"Libraries missing: {e}")

ENV = {
    "KEY": os.environ.get("GOOGLE_API_KEY"),
    "USER": os.environ.get("GMAIL_USER"),
    "PW": os.environ.get("GMAIL_APP_PASSWORD")
}
if not ENV["KEY"] or not ENV["USER"] or not ENV["PW"]: fail("Missing Secrets!")

# [RSS FETCH]
safe_keyword = urllib.parse.quote(RSS_KEYWORD)
rss_url = f"https://news.google.com/rss/search?q={safe_keyword}+when:1d&hl=en-US&gl=US&ceid=US:en"
log(f"Fetching RSS: {rss_url}")

feed = feedparser.parse(rss_url)
if not feed.entries:
    log("Trying fallback keyword 'technology'...", "WARN")
    feed = feedparser.parse("https://news.google.com/rss/search?q=technology+when:1d&hl=en-US&gl=US&ceid=US:en")
    if not feed.entries: fail("No news found.")

# [HISTORY CHECK]
history = set()
if os.path.exists(HISTORY_FILE):
    with open(HISTORY_FILE, 'r') as f: history = {line.strip() for line in f}

target = None
target_tid = None
for entry in feed.entries[:5]:
    tid = hashlib.sha256(entry.title.encode()).hexdigest()
    if tid not in history:
        target = entry
        target_tid = tid
        break

if not target:
    log("All news processed.")
    sys.exit(0)

# [V26: AI IMAGE GENERATION FUNCTION]
def get_ai_image(prompt):
    try:
        # Construct English prompt for Pollinations
        safe_prompt = urllib.parse.quote(prompt + ", photorealistic, 8k, highly detailed, cinematic lighting, wide angle, commercial photography")
        seed = int(time.time())
        # Use Flux model for best results
        image_url = f"https://image.pollinations.ai/prompt/{safe_prompt}?width=1024&height=600&model=flux&seed={seed}&nologo=true"
        return image_url
    except:
        return None

# [AI TEXT GENERATION]
genai.configure(api_key=ENV["KEY"])
valid_model_name = None
fallback_models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro', 'gemini-pro']

try:
    for m in genai.list_models():
        if 'generateContent' in m.supported_generation_methods:
            name = m.name.replace('models/', '')
            if 'flash' in name or 'pro' in name:
                valid_model_name = name
                break
except: pass

models_to_try = [valid_model_name] if valid_model_name else []
models_to_try.extend(fallback_models)

generated = None
# Request English image prompt from Gemini
prompt = f"""
Act as a blogger. Style: {random.choice(STYLES)}.
Rewrite news to Traditional Chinese (Taiwan) HTML.
News: {target.title}
Summary: {getattr(target, 'summary', '')}
Also, provide an ENGLISH description for an image header (image_prompt_en).
Format JSON: {{ "valid": true, "title": "...", "body": "...", "image_prompt_en": "..." }}
"""

for m in models_to_try:
    if not m: continue
    log(f"Trying AI model: {m}...")
    try:
        model = genai.GenerativeModel(m)
        res = model.generate_content(prompt)
        data = json.loads(res.text.replace('```json','').replace('```',''))
        if data.get("valid"):
            generated = data
            break
    except Exception as e:
        log(f"Model {m} failed: {e}", "WARN")
        time.sleep(1)

if not generated: fail("All AI models failed.")

# [IMAGE PROCESSING]
image_prompt = generated.get("image_prompt_en", target.title) # Fallback to title
image_url = get_ai_image(image_prompt)
log(f"Generated Image URL: {image_url}")

# [LINKING]
link = AFFILIATE_MAP["default"]
content = (generated["title"] + generated["body"]).lower()
for k, v in AFFILIATE_MAP.items():
    if k != "default" and k in content:
        link = v
        log(f"Matched keyword: {k}")
        break

# [EMAIL]
try:
    msg = MIMEMultipart()
    msg['Subject'] = generated["title"]
    msg['From'] = ENV["USER"]
    msg['To'] = BLOGGER_EMAIL
    
    # Construct HTML: Image -> Body -> Button
    img_html = f'<div style="margin-bottom:20px;"><img src="{image_url}" style="width:100%;border-radius:10px;" alt="{generated["title"]}"></div>' if image_url else ""
    btn_html = f'<br><div style="text-align:center;margin:30px;"><a href="{link}" style="background:#10b981;color:white;padding:12px 28px;border-radius:30px;text-decoration:none;font-weight:bold;">ðŸ‘‰ æŸ¥çœ‹ç›¸é—œå„ªæƒ </a></div>'
    
    final_body = img_html + generated["body"] + btn_html
    
    msg.attach(MIMEText(final_body, 'html'))
    
    server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
    server.login(ENV["USER"], ENV["PW"])
    server.send_message(msg)
    server.quit()
    
    with open(HISTORY_FILE, 'a') as f: f.write(target_tid + "\n")
    log("Success! Email sent with Image.")
except Exception as e:
    fail(f"SMTP Error: {e}")
