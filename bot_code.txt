#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os, sys, json, random, hashlib, smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# 1. æª¢æŸ¥å¥—ä»¶
print("ğŸ” æ­¥é©Ÿ 1: æª¢æŸ¥ç’°å¢ƒ...")
try:
    import feedparser
    import google.generativeai as genai
    print("âœ… ç’°å¢ƒæ­£å¸¸")
except ImportError as e:
    print(f"âŒ ç’°å¢ƒéŒ¯èª¤: ç¼ºå°‘å¥—ä»¶ {e}")
    sys.exit(1)

# 2. æª¢æŸ¥ Secrets
print("ğŸ” æ­¥é©Ÿ 2: æª¢æŸ¥é‡‘é‘°...")
ENV = {
    "KEY": os.environ.get("GOOGLE_API_KEY"),
    "USER": os.environ.get("GMAIL_USER"),
    "PW": os.environ.get("GMAIL_APP_PASSWORD"),
    "TO": "jhw6909014.money2025@blogger.com"
}
if not ENV["KEY"]: 
    print("âŒ éŒ¯èª¤: ç¼ºå°‘ GOOGLE_API_KEY")
    sys.exit(1)
if not ENV["USER"] or not ENV["PW"]: 
    print("âŒ éŒ¯èª¤: ç¼ºå°‘ GMAIL å¸³å¯†")
    sys.exit(1)
print("âœ… é‡‘é‘°è®€å–æˆåŠŸ")

# è¨­å®š
RSS_URL = "https://news.google.com/rss/search?q=iphone+when:1d&hl=en-US&gl=US&ceid=US:en"
print(f"ğŸ” æ­¥é©Ÿ 3: æŠ“å– RSS -> {RSS_URL}")

feed = feedparser.parse(RSS_URL)
if not feed.entries:
    print("âŒ éŒ¯èª¤: RSS æ²’æœ‰æŠ“åˆ°ä»»ä½•æ–°èã€‚è«‹å˜—è©¦æ›´æ›é—œéµå­—æˆ–ç§»é™¤ 'when:1d'ã€‚")
    sys.exit(1)
print(f"âœ… æˆåŠŸæŠ“åˆ° {len(feed.entries)} ç¯‡æ–°è")

# æº–å‚™æ­·å²ç´€éŒ„
history = set()
if os.path.exists("history.txt"):
    history = set(line.strip() for line in open("history.txt"))

# é–‹å§‹è™•ç† (åªè™•ç†ç¬¬ä¸€ç¯‡æœ‰æ•ˆçš„)
target_entry = None
for entry in feed.entries[:5]:
    tid = hashlib.sha256(entry.title.encode()).hexdigest()
    if tid not in history:
        target_entry = entry
        break

if not target_entry:
    print("âš ï¸ è­¦å‘Š: æ‰€æœ‰æ–°èéƒ½å·²ç™¼å¸ƒé (history.txt å·²åŒ…å«)ã€‚")
    # é€™è£¡ä¸å ±éŒ¯ï¼Œç®—æ­£å¸¸çµæŸ
    sys.exit(0)

print(f"ğŸ” æ­¥é©Ÿ 4: AI æ”¹å¯«ä¸­ -> {target_entry.title}...")
genai.configure(api_key=ENV["KEY"])
model = genai.GenerativeModel('gemini-1.5-flash')

prompt = f"""
è«‹å°‡æ­¤æ–°èæ”¹å¯«ç‚ºç¹é«”ä¸­æ–‡éƒ¨è½æ ¼æ–‡ç«  (HTMLæ ¼å¼)ã€‚
æ–°èæ¨™é¡Œ: {target_entry.title}
æ‘˜è¦: {getattr(target_entry, 'summary', '')}
å›å‚³æ ¼å¼ JSON: {{ "valid": true, "title": "...", "body": "..." }}
"""

try:
    res = model.generate_content(prompt)
    data = json.loads(res.text.replace('```json','').replace('```',''))
    print("âœ… AI ç”ŸæˆæˆåŠŸ")
except Exception as e:
    print(f"âŒ AI ç”Ÿæˆå¤±æ•—: {e}")
    sys.exit(1)

# ç™¼ä¿¡
print(f"ğŸ” æ­¥é©Ÿ 5: æº–å‚™ç™¼ä¿¡çµ¦ -> {ENV['TO']}...")
try:
    msg = MIMEMultipart()
    msg['Subject'] = data["title"]
    msg['From'] = ENV["USER"]
    msg['To'] = ENV["TO"]
    
    btn = f'<br><a href="https://shopee.tw/">æŸ¥çœ‹è©³æƒ…</a>'
    msg.attach(MIMEText(data["body"] + btn, 'html'))
    
    server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
    server.login(ENV["USER"], ENV["PW"])
    server.send_message(msg)
    server.quit()
    print("âœ… ç™¼ä¿¡æˆåŠŸï¼")
    
    # å¯«å…¥æ­·å²
    with open("history.txt", 'a') as f: f.write(hashlib.sha256(target_entry.title.encode()).hexdigest() + "\n")
    
except Exception as e:
    print(f"âŒ ç™¼ä¿¡å¤±æ•— (SMTP Error): {e}")
    print("è«‹æª¢æŸ¥ï¼š1. Gmail æ˜¯å¦é–‹å•Ÿå…©æ­¥é©Ÿé©—è­‰ 2. æ˜¯å¦ä½¿ç”¨ 16 ä½æ•¸æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼")
    sys.exit(1)
